<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Course Average Grade Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        // Using standard Tailwind shades for a clean, minimalist palette
                        'primary-accent': '#3b82f6', // blue-500
                        'light-gray': '#f9fafb',    // gray-50
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        /* Minimalist styles */
        body {
            background-color: #ffffff; /* Pure white background */
            font-family: 'Inter', sans-serif;
        }
        .card {
            /* Removing shadows completely for a flat, minimalist look */
            border: 1px solid #e5e7eb; /* Subtle gray border */
        }
        input, select {
            /* Minimal input styling */
            border: 1px solid #d1d5db; /* Default border */
            transition: border-color 0.15s ease-in-out;
        }
        input:focus, select:focus {
            /* Focus ring using the primary accent color */
            border-color: #3b82f6; 
            outline: none;
            box-shadow: 0 0 0 1px #3b82f6; 
        }
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] {
            -moz-appearance: textfield;
        }
    </style>
</head>
<body class="p-4 sm:p-10">
    <div id="app" class="max-w-7xl mx-auto">
        <header class="text-center mb-10">
            <h1 class="text-3xl font-light tracking-tight text-gray-900">Grade Tracker</h1>
            <p class="text-md text-gray-500">Define weights and calculate your course average.</p>
        </header>

        <!-- Loading & Auth State -->
        <div id="loading-overlay" class="fixed inset-0 bg-white bg-opacity-90 flex items-center justify-center z-50">
            <div class="text-gray-600 font-semibold text-xl flex items-center">
                <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-primary-accent" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                Loading Data...
            </div>
        </div>
        <div id="auth-info" class="mb-4 text-xs text-center text-gray-400"></div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
            <!-- 1. Category Weight Settings -->
            <div class="lg:col-span-1 card bg-white p-5 rounded-lg">
                <h2 class="text-lg font-medium mb-4 text-gray-800 border-b pb-2">1. Category Weights (%)</h2>
                <div id="category-weights" class="space-y-3">
                    <!-- Category inputs will be rendered here -->
                </div>
                <button onclick="addCategory()" class="w-full mt-4 py-2 text-primary-accent border border-primary-accent font-medium rounded-lg hover:bg-light-gray transition duration-150">
                    + Add Category
                </button>
            </div>

            <!-- 2. Course Calculation Summary -->
            <div class="lg:col-span-2 card bg-white p-5 rounded-lg">
                <h2 class="text-lg font-medium mb-4 text-gray-800 border-b pb-2">3. Course Grade Summary</h2>
                <div id="category-summary" class="space-y-3 mb-6">
                    <!-- Summary of each category's performance -->
                </div>
                <div class="p-4 bg-light-gray border-l-4 border-primary-accent rounded-lg flex justify-between items-center">
                    <span class="text-xl font-medium text-gray-700">Overall Course Average:</span>
                    <span id="overall-average" class="text-3xl font-bold text-gray-900">--%</span>
                </div>
                <div id="weight-check" class="mt-3 text-xs font-medium text-red-500 hidden">
                    Warning: Category weights do not sum to 100%. Please adjust.
                </div>
            </div>
        </div>

        <!-- 3. Assignment Input Table -->
        <div class="card bg-white p-5 rounded-lg">
            <h2 class="text-lg font-medium mb-4 text-gray-800 border-b pb-2">2. Individual Assignments</h2>

            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-white">
                    <tr>
                        <th class="px-3 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider w-1/4">Name</th>
                        <th class="px-3 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Score (%)</th>
                        <th class="px-3 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Weight</th>
                        <th class="px-3 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Category</th>
                        <th class="px-3 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Weighted Score</th>
                        <th class="px-3 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody id="assignments-table-body" class="bg-white divide-y divide-gray-100">
                    <!-- Assignments will be rendered here -->
                </tbody>
            </table>

            <button onclick="addAssignment()" class="w-full mt-4 py-2 px-4 bg-primary-accent text-white font-medium rounded-lg hover:bg-blue-600 transition duration-150">
                + Add Assignment
            </button>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global State (Replaced by Firestore)
        let categories = {
            "DAILY": { weight: 15, key: 'DAILY' },
            "QUIZ": { weight: 20, key: 'QUIZ' },
            "MAJOR": { weight: 65, key: 'MAJOR' },
        };
        let assignments = [];
        let db;
        let auth;
        let userId = null;
        let isAuthReady = false;
        const DATA_COLLECTION = 'grade_data';
        const DATA_DOC_ID = 'current_class';

        // Global variables provided by the canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        setLogLevel('Debug');

        // Helper to format number to 2 decimal places
        const formatDecimals = (num) => isNaN(num) ? '--' : num.toFixed(2);

        // --- CORE APPLICATION LOGIC ---

        /**
         * Calculates the overall course grade based on current assignments and category weights.
         */
        window.calculateGrade = function() {
            const summary = {};
            let totalCategoryWeight = 0;

            // 1. Initialize summary object and calculate total category weight
            Object.keys(categories).forEach(catName => {
                summary[catName] = {
                    weight: categories[catName].weight,
                    totalEarned: 0,
                    totalPossible: 0,
                    percentage: 0,
                    weightedContribution: 0
                };
                totalCategoryWeight += categories[catName].weight;
            });

            // Check if weights sum to 100
            const weightCheckEl = document.getElementById('weight-check');
            if (Math.abs(totalCategoryWeight - 100) > 0.01) {
                weightCheckEl.textContent = `Warning: Category weights sum to ${formatDecimals(totalCategoryWeight)}%. Recommended to sum to 100%.`;
                weightCheckEl.classList.remove('hidden');
            } else {
                weightCheckEl.classList.add('hidden');
            }
            
            // 2. Aggregate points by Category
            assignments.forEach(assign => {
                if (assign.category && summary[assign.category]) {
                    // Check for Extra Credit exclusion (score > 100)
                    if (assign.score > 100) {
                        console.log(`Excluding assignment ${assign.name} (score > 100) from calculation.`);
                        return;
                    }

                    const assignWeight = parseFloat(assign.weight) || 0;
                    const assignScore = parseFloat(assign.score) || 0;

                    // Weighted Score = Score (%) * Assignment Weight
                    const weightedScore = (assignScore / 100) * (assignWeight * 100);
                    // Weighted Total Points = 100 * Assignment Weight
                    const weightedTotalPoints = 100 * assignWeight; 
                    
                    if (assignWeight > 0) {
                        summary[assign.category].totalEarned += weightedScore;
                        summary[assign.category].totalPossible += weightedTotalPoints;
                    }
                }
            });

            // 3. Calculate Category Percentages and Overall Grade
            let overallWeightedSum = 0;
            const categorySummaryEl = document.getElementById('category-summary');
            categorySummaryEl.innerHTML = '';
            
            Object.keys(summary).forEach(catName => {
                const cat = summary[catName];
                
                cat.percentage = cat.totalPossible > 0 
                    ? (cat.totalEarned / cat.totalPossible) * 100 
                    : 0;
                
                cat.weightedContribution = cat.percentage * (cat.weight / 100);
                overallWeightedSum += cat.weightedContribution;

                // Render Summary (Minimalist style)
                categorySummaryEl.innerHTML += `
                    <div class="p-3 bg-white rounded-lg flex justify-between items-center border-b border-gray-200">
                        <span class="text-gray-600 font-normal">${catName} (${cat.weight}% of course):</span>
                        <div class="text-right">
                            <p class="text-lg font-bold text-gray-900">${formatDecimals(cat.percentage)}%</p>
                            <p class="text-xs text-gray-400">
                                ${formatDecimals(cat.totalEarned)} / ${formatDecimals(cat.totalPossible)} pts
                            </p>
                        </div>
                    </div>
                `;
            });
            
            // 4. Display Overall Average
            document.getElementById('overall-average').textContent = `${formatDecimals(overallWeightedSum)}%`;
            
            // 5. Re-render tables
            renderCategoryWeights();
            renderAssignmentsTable();
        }

        // --- UI RENDERING FUNCTIONS ---

        /**
         * Renders the category weight input fields.
         */
        function renderCategoryWeights() {
            const el = document.getElementById('category-weights');
            el.innerHTML = '';
            
            Object.keys(categories).forEach(key => {
                const cat = categories[key];
                const div = document.createElement('div');
                div.className = 'flex items-center space-x-2';
                div.innerHTML = `
                    <input type="text" value="${cat.key}" placeholder="Category Name" onchange="updateCategoryName('${cat.key}', this.value)"
                        class="flex-grow p-2 border rounded-lg text-sm bg-white">
                    <input type="number" value="${cat.weight}" placeholder="Weight %" min="0" oninput="updateCategoryWeight('${cat.key}', this.value)"
                        class="w-20 p-2 border rounded-lg text-right text-sm bg-white">
                    <button onclick="removeCategory('${cat.key}')" class="text-red-500 hover:text-red-700 p-1 rounded-full transition duration-150" aria-label="Remove category">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                    </button>
                `;
                el.appendChild(div);
            });
        }

        /**
         * Renders the assignments input table.
         */
        function renderAssignmentsTable() {
            const el = document.getElementById('assignments-table-body');
            el.innerHTML = '';
            const categoryKeys = Object.keys(categories);
            
            assignments.forEach((assign, index) => {
                const weightedScore = (parseFloat(assign.score) / 100) * (parseFloat(assign.weight) * 100);
                
                const row = document.createElement('tr');
                row.className = 'hover:bg-light-gray';
                row.innerHTML = `
                    <td class="px-3 py-3 whitespace-nowrap">
                        <input type="text" value="${assign.name}" placeholder="Assignment Name" onchange="updateAssignment(${index}, 'name', this.value)"
                            class="w-full p-2 border rounded-lg text-sm bg-white">
                    </td>
                    <td class="px-3 py-3 whitespace-nowrap">
                        <input type="number" value="${assign.score}" placeholder="e.g. 90" min="0" oninput="updateAssignment(${index}, 'score', this.value)"
                            class="w-full p-2 border rounded-lg text-sm text-right bg-white">
                    </td>
                    <td class="px-3 py-3 whitespace-nowrap">
                        <input type="number" value="${assign.weight}" placeholder="e.g. 1.0" min="0" oninput="updateAssignment(${index}, 'weight', this.value)"
                            class="w-full p-2 border rounded-lg text-sm text-right bg-white">
                    </td>
                    <td class="px-3 py-3 whitespace-nowrap">
                        <select onchange="updateAssignment(${index}, 'category', this.value)"
                            class="w-full p-2 border rounded-lg bg-white text-sm">
                            <option value="">Select Category</option>
                            ${categoryKeys.map(key => `<option value="${key}" ${assign.category === key ? 'selected' : ''}>${key}</option>`).join('')}
                        </select>
                    </td>
                    <td class="px-3 py-3 whitespace-nowrap text-right font-medium text-gray-700">
                        ${isNaN(weightedScore) ? 'N/A' : formatDecimals(weightedScore)}
                    </td>
                    <td class="px-3 py-3 whitespace-nowrap text-center">
                        <button onclick="removeAssignment(${index})" class="text-red-500 hover:text-red-700 p-1 rounded-full transition duration-150" aria-label="Remove assignment">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        </button>
                    </td>
                `;
                el.appendChild(row);
            });
        }

        // --- MUTATION & STATE MANAGEMENT FUNCTIONS ---

        /**
         * Saves the current state (categories and assignments) to Firestore.
         */
        async function saveState() {
            if (!db || !userId) {
                console.error("Firestore not initialized or user not logged in.");
                return;
            }
            try {
                // Private data path: /artifacts/{appId}/users/{userId}/grade_data/{docId}
                const docRef = doc(db, 'artifacts', appId, 'users', userId, DATA_COLLECTION, DATA_DOC_ID);
                await setDoc(docRef, {
                    categories: categories,
                    assignments: assignments,
                    lastUpdated: new Date().toISOString()
                });
                console.log("State saved successfully!");
            } catch (error) {
                console.error("Error saving state to Firestore:", error);
            }
        }

        /**
         * Loads state from a snapshot and recalculates.
         */
        function loadState(data) {
            if (data && data.categories) {
                categories = data.categories;
                // Re-keying is important as JSON doesn't preserve key order, and object destructuring can sometimes be problematic
                categories = Object.keys(categories).reduce((acc, key) => {
                    acc[key] = { ...categories[key], key };
                    return acc;
                }, {});
            }
            if (data && data.assignments) {
                assignments = data.assignments;
            }
            calculateGrade();
        }
        
        // --- CATEGORY ACTIONS ---

        window.updateCategoryName = function(oldKey, newKey) {
            newKey = newKey.toUpperCase().trim().replace(/[^A-Z0-9]/g, '_'); // Sanitize key
            if (oldKey === newKey || newKey === "") {
                categories[oldKey].key = newKey === "" ? oldKey : newKey; // Restore or update
                saveState();
                return;
            }

            if (categories[newKey]) {
                console.error("Category name already exists.");
                renderCategoryWeights(); // Re-render to show original name
                return;
            }

            // Create new category object, update assignments, then delete old key
            categories[newKey] = { ...categories[oldKey], key: newKey };
            delete categories[oldKey];

            assignments.forEach(assign => {
                if (assign.category === oldKey) {
                    assign.category = newKey;
                }
            });

            saveState();
        }

        window.updateCategoryWeight = function(key, weight) {
            const numWeight = parseFloat(weight);
            categories[key].weight = isNaN(numWeight) ? 0 : numWeight;
            calculateGrade(); // Recalculate immediately for feedback
            saveState();
        }

        window.addCategory = function() {
            const newKey = `NEW_CATEGORY_${Object.keys(categories).length + 1}`;
            categories[newKey] = { weight: 0, key: newKey };
            saveState();
        }

        window.removeCategory = function(key) {
            // Remove category from assignments first
            assignments = assignments.map(assign => {
                if (assign.category === key) {
                    assign.category = ''; // Decategorize
                }
                return assign;
            });
            delete categories[key];
            saveState();
        }

        // --- ASSIGNMENT ACTIONS ---

        window.updateAssignment = function(index, field, value) {
            if (!assignments[index]) return;

            if (field === 'score' || field === 'weight') {
                const numValue = parseFloat(value);
                assignments[index][field] = isNaN(numValue) ? 0 : numValue;
            } else {
                assignments[index][field] = value;
            }
            calculateGrade(); // Recalculate immediately for feedback
            saveState();
        }

        window.addAssignment = function() {
            assignments.push({
                name: `Assignment ${assignments.length + 1}`,
                category: Object.keys(categories)[0] || '',
                score: 100,
                weight: 1.0
            });
            saveState();
        }

        window.removeAssignment = function(index) {
            assignments.splice(index, 1);
            saveState();
        }

        // --- FIREBASE INITIALIZATION ---

        async function initFirebase() {
            if (!firebaseConfig) {
                document.getElementById('loading-overlay').innerHTML = `<div class="p-4 bg-red-100 text-red-700 rounded-lg">Error: Firebase configuration is missing. Data cannot be saved.</div>`;
                return;
            }

            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                const authInfoEl = document.getElementById('auth-info');
                
                // 1. Auth & Sign In
                await new Promise(resolve => {
                    onAuthStateChanged(auth, async (user) => {
                        if (user) {
                            userId = user.uid;
                            authInfoEl.textContent = `Authenticated User ID (for data storage): ${userId}`;
                        } else {
                            // If no user is signed in (shouldn't happen with the token)
                            if (initialAuthToken) {
                                await signInWithCustomToken(auth, initialAuthToken).catch(e => {
                                    console.error("Custom token sign-in failed:", e);
                                    signInAnonymously(auth); // Fallback to anonymous
                                });
                            } else {
                                await signInAnonymously(auth);
                            }
                        }
                        isAuthReady = true;
                        resolve();
                    });
                });

                // 2. Start Firestore Listener
                if (userId) {
                    // Private data path: /artifacts/{appId}/users/{userId}/grade_data/{docId}
                    const docRef = doc(db, 'artifacts', appId, 'users', userId, DATA_COLLECTION, DATA_DOC_ID);
                    
                    onSnapshot(docRef, (docSnap) => {
                        document.getElementById('loading-overlay').classList.add('hidden');
                        if (docSnap.exists()) {
                            console.log("Data loaded from Firestore.");
                            loadState(docSnap.data());
                        } else {
                            console.log("No data found in Firestore, using defaults.");
                            // Save initial state if no document exists
                            saveState();
                            calculateGrade(); // Initial render with defaults
                        }
                    }, (error) => {
                        document.getElementById('loading-overlay').classList.add('hidden');
                        console.error("Firestore listener error:", error);
                        // Fallback to initial rendering if listener fails
                        calculateGrade(); 
                    });
                } else {
                    document.getElementById('loading-overlay').classList.add('hidden');
                    console.error("User ID not available after authentication attempt.");
                    calculateGrade(); // Initial render with defaults
                }
                
            } catch (error) {
                document.getElementById('loading-overlay').classList.add('hidden');
                console.error("Error initializing Firebase:", error);
            }
        }

        // Initialize the app on window load
        window.onload = initFirebase;
    </script>
</body>
</html>

